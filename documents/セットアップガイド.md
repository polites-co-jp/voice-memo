# セットアップガイド：APIキー取得手順

`.env` ファイルに設定が必要な各種キーの取得手順、および **AWSの接続情報** の設定方法を説明します。

---

## 0. AWS 接続情報の設定

デプロイ（`serverless deploy`）を行うには、コンピュータにAWSの認証情報を設定する必要があります。主な方法は以下の2点です。

### 方法A: AWS CLI を使用する（推奨）
1.  **AWS CLI** をインストールします。
2.  ターミナルで `aws configure` を実行します。
3.  `AWS Access Key ID` と `AWS Secret Access Key` を入力します。
4.  `Default region name` (例: `us-east-1`) と `Default output format` (`json`) を入力します。

### AWS アクセスキーの取得方法
1.  **AWS マネジメントコンソール** にサインインします。
2.  **IAM (Identity and Access Management)** コンソールに移動します。
3.  左側のメニューから **「ユーザー」** を選択し、対象のユーザー（例: `kou`）をクリックします。
4.  **「セキュリティ認証情報」** タブをクリックします。
5.  **「アクセスキー」** セクションまでスクロールし、**「アクセスキーを作成」** をクリックします。
6.  ユースケースとして **「コマンドラインインターフェイス (CLI)」** を選択し、確認のチェックボックスにチェックを入れて「次へ」をクリックします。
7.  （任意）説明タグを設定して「アクセスキーを作成」をクリックします。
8.  **「アクセスキー ID」** と **「シークレットアクセスキー」** が表示されます。**シークレットキーはこの時しか表示・ダウンロードできないため、必ず控えておいてください。**

### 権限エラー（iam:CreateRole等）の解決手順（AWSコンソール）

ご提示いただいたエラーは、ユーザー `kou` にリソースを作成する権限がないために発生しています。以下の手順で権限を追加してください。

1.  **AWS マネジメントコンソール** にログインします。
2.  上部の検索窓に **「IAM」** と入力し、IAM サービスへ移動します。
3.  左側メニューの **「ユーザー」** をクリックします。
4.  一覧から **「kou」** ユーザーをクリックして詳細を開きます。
5.  **「許可」** タブにある **「許可を追加」** ボタン（右側）をクリックし、プルダウンから **「許可を追加」** を選択します。
6.  **「ポリシーを直接アタッチする」** を選択します。
7.  許可ポリシーの検索窓に **「AdministratorAccess」** と入力します。
8.  一覧に出てきた `AdministratorAccess` の左側のチェックボックスを **オン** にします。
    *   *※開発用としてはこれが最も確実です。もし権限を最小限にしたい場合は、代わりに `CloudFormationFullAccess`, `AWSLambda_FullAccess`, `AmazonS3FullAccess`, `IAMFullAccess` などを選択してください。*
9.  右下の **「次へ」** をクリックし、内容を確認して **「許可を追加」** をクリックします。

これで設定は完了です。再度ターミナルで `serverless deploy` を実行してください。

---

## よくある質問とトラブルシューティング

### 1. ボットが「オフライン」のままですが？
今回のような **Interaction (Webhook)** 形式のボットは、サーバーに常駐しない（サーバーレス）ため、**常にオフライン表示**になります。これは正常な動作です。コマンドが実行された時だけ Lambda が起動して処理を行います。

### 2. 音声メモを投稿しても反応しません
このボットは「投稿されたことを自動検知」するのではなく、**「ユーザーがコマンドを実行する」** ことで動作します。

動作させるには以下の **「コマンド登録」** が必要です。

#### コマンドの登録手順
1.  `register-commands.js` を作成しました。
2.  ファイル内の `appId` を自分の **Discord Developer Portal > General Information > APPLICATION ID** に書き換えます。
3.  ターミナルで `node register-commands.js` を実行します。
4.  Discord上で適当なメッセージ（音声メモ）を **右クリック（または長押し）＞ アプリ ＞ 文字起こし** を選択すると処理が始まります。

### 3. 「INTERACTIONS ENDPOINT URL」の設定
`serverless deploy` の完了時に表示された `endpoint:` の URL を、Discord Developer Portal の **General Information > INTERACTIONS ENDPOINT URL** に貼り付けて保存してください。これが設定されていないと Discord から Lambda に信号が飛びません。

### スタックの状態エラー（ROLLBACK_COMPLETE等）が出た場合

`is in UPDATE_ROLLBACK_COMPLETE_CLEANUP_IN_PROGRESS state and can not be updated` といったエラーが出た場合は、前回の失敗によりAWS側の状態が「中途半端」になっています。

この場合は、一度作成されかけたリソースを削除する必要があります：

1.  **AWS マネジメントコンソール** で **「CloudFormation」** を検索して移動します。
2.  スタック一覧から **`voice-memo-automation-dev`** を探して選択します。
3.  右上の **「削除」** ボタンをクリックします。
4.  削除が完了（一覧から消える）するまで数分待機します。
5.  削除完了後、再度ターミナルから `serverless deploy` を実行してください。

## 1. Discord 関連 (`DISCORD_PUBLIC_KEY`, `DISCORD_TOKEN`)

1.  **Discord Developer Portal** ([https://discord.com/developers/applications](https://discord.com/developers/applications)) にアクセスします。
2.  **"New Application"** をクリックし、任意の名前（例: `VoiceMemoBot`）でアプリを作成します。
3.  **General Information** タブ:
    *   `PUBLIC KEY` をコピーして `.env` の `DISCORD_PUBLIC_KEY` に設定します。
4.  **Bot** タブ:
    *   **"Reset Token"** (または "Copy Token") をクリックしてトークンを取得し、`.env` の `DISCORD_TOKEN` に設定します。
    *   **Privileged Gateway Intents** セクションで `MESSAGE CONTENT INTENT` を ON にします（メッセージ内容を読み取るために必要です）。
5.  **OAuth2** タブ -> **URL Generator**:
    *   `scopes`: `bot`, `applications.commands` を選択。
    *   `bot permissions`: `Send Messages`, `Read Message History`, `Use Slash Commands` 等を選択。
    *   生成された URL をブラウザで開き、自分のサーバーにボットを招待します。

---

## 2. Gemini 関連 (`GEMINI_API_KEY`)

1.  **Google AI Studio** ([https://aistudio.google.com/](https://aistudio.google.com/)) にアクセスします。
2.  ログイン後、左側のメニューから **"Get API key"** をクリックします。
3.  **"Create API key in new project"** をクリックしてキーを生成します。
4.  表示されたキーをコピーして `.env` の `GEMINI_API_KEY` に設定します。

---

## 3. GitHub 関連 (`GITHUB_TOKEN`, `TARGET_REPO`)

### GITHUB_TOKEN の取得
1.  **GitHub Settings** ([https://github.com/settings/tokens](https://github.com/settings/tokens)) にアクセスします。
2.  **"Generate new token"** (Classic または Fine-grained) を選択します。
    *   **Classic の場合**: `repo` スコープ全体にチェックを入れます。
3.  生成されたトークンをコピーして `.env` の `GITHUB_TOKEN` に設定します。

### TARGET_REPO の設定
1.  保存先となるリポジトリを作成します。
2.  リポジトリの URL が `https://github.com/ユーザー名/リポジトリ名` の場合、`.env` の `TARGET_REPO` に `ユーザー名/リポジトリ名` を設定します。

---

## 4. デプロイの準備

1.  ターミナルで `npm install` を実行して依存関係をインストールします。
2.  `serverless deploy` を実行して AWS にデプロイします。
3.  デプロイ後に表示される API Gateway の URL (Endpoint) を、**Discord Developer Portal** の **General Information** -> **INTERACTIONS ENDPOINT URL** に貼り付けて保存します。
