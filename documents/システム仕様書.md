# システム仕様書：Discord音声メモ自動要約・GitHub保存システム

## 1. 概要
本システムは、Discordに投稿された音声メモを自動的に取得し、Google Gemini APIを用いて文字起こしおよび要約を行い、その結果をDiscordに通知するとともに、MarkdownファイルとしてGitHubリポジトリに保存するサーバーレスアプリケーションである。

## 2. アーキテクチャ構成
- **プラットフォーム**: AWS Lambda (Serverless Framework)
- **ランタイム**: Node.js 20.x
- **トリガー**: Amazon API Gateway (HTTP API) `POST /interactions`

## 3. 機能要件

### 3.1 Discord連携
- **Interactions Endpoint**: DiscordからのInteraction Webhookを受信。
- **署名検証**: `discord-interactions` ライブラリを使用し、Ed25519署名を検証。不正なリクエストは401で拒否。
- **音声ファイル取得**: InteractionデータまたはMessageデータから音声添付ファイルのURLを取得。
- **通知**:
  - 全文投稿チャンネル: 文字起こし全文を投稿。
  - 要約投稿チャンネル: Geminiによる要約を投稿。

### 3.2 AI処理 (Gemini)
- **モデル**: Gemini 2.5 Flash
- **入力**: 音声ファイル (MP3/OGG/WAV等)
- **出力**:
  - タイトル (ファイル名に使用)
  - 要約 (Markdown形式)
  - キーワード (5つ程度抽出)
  - 文字起こし全文
- **プロンプト**: 音声内容に基づき、適切なタイトル、要約、およびキーワードを生成するよう指示。

### 3.3 GitHub連携
- **保存先**: 指定されたリポジトリ (`TARGET_REPO`)
- **要約ファイル**:
  - パス: `音声メモ/YYYYMMDDHHmmss_[タイトル].md`
  - 内容: キーワード部分を `../キーワード/[キーワード].md` へのリンクに変換。
- **キーワードインデックス**:
  - パス: `キーワード/[キーワード].md`
  - 抽出されたキーワード毎にファイルを確認（存在しない場合は作成）。
  - ファイル末尾に音声メモ（`../音声メモ/[ファイル名]`）への相対リンクを追記。
- **コミットメッセージ**: `Add voice memo summary: [タイトル] and update keywords`

## 4. 環境変数

| 変数名 | 説明 |
| --- | --- |
| `DISCORD_PUBLIC_KEY` | Discord Interaction署名検証用公開鍵 |
| `DISCORD_TOKEN` | Discord Bot Token (メッセージ送信、ファイル取得用) |
| `GEMINI_API_KEY` | Google Gemini API Key |
| `GITHUB_TOKEN` | GitHub Personal Access Token (repoスコープ) |
| `TARGET_REPO` | 保存先リポジトリ (例: `username/repo`) |
| `TRANSCRIPT_CHANNEL_ID` | (Optional) 文字起こし投稿用チャンネルID |
| `SUMMARY_CHANNEL_ID` | (Optional) 要約投稿用チャンネルID |

## 5. 制約事項・エラー処理
- **Lambda制限**: 実行時間（デフォルト設定に依存、最大15分）、メモリ等を考慮。
- **ファイルサイズ**: 20MBを超える音声ファイルについては処理をスキップまたはエラー通知を行う。
- **タイムアウト**: Discord Interactionの初期応答(3秒)要件に対し、必要なハンドリング（Deferred Response等）を行う。

